#!/usr/bin/env bash

# Required environment variables:
#   HOSTNAME
#   LASTPASS_USERNAME

error=

# verifies that required environment variables are set
function check_environment {
  if [[ -z $LASTPASS_USERNAME ]]; then
    error="[check_environment] Missing required environment variable: LASTPASS_USERNAME"
    return 1
  fi
}

# verifies that the user has authenticated with LastPass
function ensure_authentication {
  if ! lpass status "${LASTPASS_USERNAME}" >/dev/null; then
    if ! lpass login "${LASTPASS_USERNAME}" 2>/dev/null >/dev/null; then
      echo "ensure_authentication: User cancelled authentication." >&2 
      return 1
    fi
  fi
}

if ! check_environment; then
  echo "${error}" 1>&2
  echo "Unable to fetch environment secrets." 1>&2
  exit 1
fi

if ! ensure_authentication; then
  echo "${error}" 1>&2
  echo "Unable to fetch environment secrets." 1>&2
  exit 2
fi

mapfile -t variables < <(fetch-secret --key "automation/hosts/${HOSTNAME}/.env")
for variable in "${variables[@]}"; do
  export "$variable"
done


-- todo 
- do not fail if the host does not have env secrets
- allow for project env secrets
- allow for user env secrets
